<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RuleApp - Galery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
      .bg-primary-color {
        background-color: #22272c;
        color: white;
      }
      .bg-secondary-color {
        background-color: #303345;
      }
      .bg-tertiary-color {
        background-color: #303345;
      }
      .bg-cueternary-color {
        background-color: #505163;
      }
      .border-secondary-color {
        border: solid 2px #505163;
      }
    </style>
  </head>
  <body id="app" class="bg-primary-color">
    <div id="appShowImageFull" class="hidden"></div>

    <!-- ======================================================================= -->
    <!-- contenedor de buscador en la galeria =================================== -->
    <div
      id="searchContainer"
      class="bg-primary-color p-3 z-5 w-screen flex flex-col justify-center items-center"
    >
      <div class="flex flex-col w-screen px-3">
        <div
          id="tagsSelectedSearch"
          class="flex list-none flex-row overflow-x-scroll overflow-hidden"
        ></div>
      </div>
      <div class="flex bg-primary-color px-3 flex-row w-screen h-20 p-3 mt-2">
        <div
          class="flex items-center border-secondary-color bg-secondary-color outline-transparent w-full mb-2 rounded-xl"
        >
          <i
            stroke="white"
            stroke-width="1"
            data-feather="search"
            style="width: 22px; height: 22px"
            class="ml-2"
          ></i>
          <input
            style="outline: none"
            class="w-full h-full bg-secondary-color ml-1 outline-transparent rounded-xl"
            placeholder="Search tags..."
            type="text"
            id="searchTagsInput"
          />
        </div>
        <button
          style="width: 60px"
          onclick="useSearchInWeb()"
          class="bg-secondary-color text-white ml-2 flex-auto h-12 rounded-xl flex items-center justify-center"
        >
          <i
            stroke-width="2"
            data-feather="search"
            style="width: 20px; height: 20px; opacity: 1"
            class="mx-2 text-white"
            stroke="white"
          ></i>
        </button>
      </div>
      <div
        id="tagsSearched"
        class="flex w-full px-2 pl-0 pt-0 min-h-10 rounded-xl overflow-x-scroll mb-3"
      ></div>
    </div>
    <!-- ======================================================================= -->
    <!-- ======================================================================= -->
    <!-- ======================================================================= -->
    <div id="galeryContainer">
      <div
        style="height: 65px; margin-top: -80px"
        class="justify-center flex-row items-center shadow-xl rounded-full top-full flex w-[calc(100%-2.5rem)] fixed bg-white mx-5"
      >
        <a href="./index.html">
          <i
            stroke-width="1"
            data-feather="arrow-left"
            style="width: 30px; height: 30px; opacity: 0.4"
            class="mx-4"
          ></i>
        </a>
        <i
          stroke-width="1"
          data-feather="home"
          style="width: 30px; height: 30px; opacity: 1"
          class="mx-4"
        ></i>
        <i
          onclick="openSearchInweb()"
          stroke-width="1"
          data-feather="search"
          style="width: 30px; height: 30px; opacity: 0.4"
          class="mx-4"
        ></i>

        <i
          onclick="changeImagesSize()"
          stroke-width="1"
          data-feather="image"
          style="width: 30px; height: 30px; opacity: 0.4"
          class="mx-4"
        ></i>
        <i
          stroke-width="1"
          data-feather="columns"
          style="width: 30px; height: 30px; opacity: 0.4"
          class="mx-4"
        ></i>
      </div>
      <div class="flex flex-row p-1 px-4 width-full flex-wrap">
        <div
          class="w-[calc(50%-7px)]"
          id="galeryCol1"
          style="margin-left: 0px"
        ></div>
        <div
          class="w-[calc(50%-7px)]"
          id="galeryCol2"
          style="margin-left: 13px"
        ></div>
      </div>
      <div
        id="bigImagesGalery"
        class="flex flex-row p-1 width-full flex-wrap pt-5 -mt-5"
      ></div>
      <div
        class="flex flex-row p-1 w-full mt-10 justify-center"
        style="margin-bottom: 150px"
      >
        <div class="h-10 flex items-center justify-center">
          <i
            onclick="previousPage()"
            stroke-width="1"
            data-feather="chevron-left"
            style="width: 30px; height: 30px; opacity: 1"
            class="mx-4"
          ></i>
        </div>
        <div
          class="flex flex-row items-center w-100 justify-center items-center"
        >
          <div
            id="pageNumber"
            class="mx-1 bg-black rounded-full text-white flex h-10 items-center px-4 justify-center"
          >
            <span>Page 1</span>
          </div>
        </div>
        <div class="h-10 flex items-center justify-center">
          <i
            onclick="nextPage()"
            stroke-width="1"
            data-feather="chevron-right"
            style="width: 30px; height: 30px; opacity: 1"
            class="mx-4"
          ></i>
        </div>
      </div>
    </div>
    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-1.12.3.js"
    ></script>
    <script>
      const BACKEND_URL = "https://ruleappserver-10d4170b9aef.herokuapp.com";

      let pageID = 0;

      feather.replace();

      let iamgeGalery = [];

      let tagsSelected = [
        { id: 1, name: "one_piece" },
        { id: 2, name: "animated" },
        { id: 2, name: "luffy" },
        { id: 2, name: "luffy_nami" },
        { id: 2, name: "animated" },
      ];

      let imageCol1 = [];
      let imageCol2 = [];
      let imageCol1HTML = "";
      let imageCol2HTML = "";

      $("#searchTagsInput").on("input", function () {
        searchTagsInput($(this).val());
      });

      //hacer scroll hasta el final de las tags
      function scrollToHorizontalEnd(element) {
        element.scrollLeft = element.scrollWidth - element.clientWidth;
      }
      //==========================================================================

      async function deleteTagsSelected(index) {
        $("#tagsSelectedSearch").html("");

        tagsSelected.splice(index, 1);

        tagsSelected.map((tag, index) => {
          $("#tagsSelectedSearch").append(
            `<li onclick="deleteTagsSelected(${index})" style="white-space: nowrap"  class="h-9 hover:opacity-40 mr-2 items-center justify-center flex list-none bg-secondary-color text-white p-1 px-3 rounded-xl"><span class="ml-2">${tag}</span><img class="w-4 h-4 ml-1 opacity-60" src="./img/x(1).svg"/></li>`
          );
        });
        await window.localStorage.setItem(
          "tagsSelected",
          JSON.stringify(tagsSelected)
        );
        getGaleyImages();
      }
      async function showSelectedTagsOnInit() {
        $("#tagsSelectedSearch").html("");
        tagsSelected = [];
        tagsSelected = await JSON.parse(
          window.localStorage.getItem("tagsSelected")
        );

        tagsSelected.map((tag, index) => {
          $("#tagsSelectedSearch").append(
            `<li onclick="deleteTagsSelected(${index})" style="white-space: nowrap"  class="h-9 hover:opacity-40 mr-2 items-center justify-center flex list-none bg-secondary-color text-white p-1 px-3 rounded-xl"><span class="ml-2">${tag}</span><img class="w-4 h-4 ml-1 opacity-60" src="./img/x(1).svg"/></li>`
          );
        });

        const scrollableElement = document.getElementById("tagsSelectedSearch");
        document.getElementById("searchTagsInput").value = "";
      }
      function addTags(tags) {
        $("#tagsSelectedSearch").html("");

        tagsSelected.push(tags);

        tagsSelected.map((tag, index) => {
          $("#tagsSelectedSearch").append(
            `<li onclick="deleteTagsSelected(${index})" style="white-space: nowrap"  class="h-9 hover:opacity-40 mr-2 items-center justify-center flex list-none bg-secondary-color text-white p-1 px-3 rounded-xl"><span class="ml-2">${tag}</span><img class="w-4 h-4 ml-1 opacity-60" src="./img/x(1).svg"/></li>`
          );
        });

        const scrollableElement = document.getElementById("tagsSelectedSearch");
        scrollToHorizontalEnd(scrollableElement);
        document.getElementById("searchTagsInput").value = "";
      }

      function showSelectedTags(tags) {
        $("#tagsSearched").html("");

        $("#tagsSearched").removeClass("hidden");
        tags.map((tag) => {
          $("#tagsSearched").append(
            `<li onclick="addTags('${tag.name}')" style="white-space: nowrap" class="hover:opacity-40 flex items-center w-auto mx-1 max-h-9 list-none bg-secondary-color text-white p-1 px-3 rounded-xl" > ${tag.name} <i stroke="white" stroke-width="1" data-feather="arrow-right" style="width: 15px; height: 15px" class="ml-1" ></i> </li>`
          );
        });
        feather.replace();
      }

      async function searchTagsInput(el) {
        const textoConGuiones = el.replaceAll(/ /g, "_");
        $("#searchTagsInput").val(textoConGuiones);

        let reqOptions = {
          url: `${BACKEND_URL}/rule/tags/${el}`,
          method: "GET",
        };

        let response = await axios.request(reqOptions);
        if (!response.data.null) {
          showSelectedTags(response.data);
        } else {
          console.log("no se ha encontrado nada");
        }
      }

      function scrollToTop(element) {
        window.scrollTo({
          top: 0,
          behavior: "smooth",
        });
        //element.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      async function printRelatedSelected() {
        /*  $("#tagsSearched").html(""); */

        let reqOptions = {
          url: `${BACKEND_URL}/rule/tags/${tagsSelected[0]}`,
          method: "GET",
        };

        let response = await axios.request(reqOptions);
        if (!response.data.null) {
          /* $("#tagsSearched").removeClass("hidden"); */
          showSelectedTags(response.data);
          /* response.data.forEach((tag, index) => {
            tags.map((tag) => {});
            $("#tagsSearched").append(
              `<li onclick="addTags('${tag.name}')" style="white-space: nowrap" class="hover:opacity-40 flex items-center w-auto mx-1 max-h-9 list-none bg-secondary-color text-white p-1 px-3 rounded-xl" > ${tag.name} <i stroke="white" stroke-width="1" data-feather="arrow-right" style="width: 15px; height: 15px" class="ml-1" ></i> </li>`
            );
          }); */
        } else {
          console.log("no se ha encontrado nada");
        }
      }
      async function printimages() {
        let smallImagesLocalStorage = await window.localStorage.getItem(
          "smallImages"
        );
        $("#galeryCol1").html("");
        $("#galeryCol2").html("");
        $("#bigImagesGalery").html("");
        imageCol1 = [];
        imageCol2 = [];
        imageCol1HTML = "";
        imageCol2HTML = "";

        document.getElementById("pageNumber").innerHTML = `<span>Page ${
          pageID + 1
        }</span>`;

        if (smallImagesLocalStorage == "true") {
          for (let i = 0; i < iamgeGalery.length; i++) {
            if (i % 2 == 0) {
              imageCol1.push(iamgeGalery[i]);
            } else {
              imageCol2.push(iamgeGalery[i]);
            }
          }

          for (let i = 0; i < imageCol1.length; i++) {
            if (i == imageCol1.length - 1) {
              imageCol1HTML += `<img onclick="showImageFullSize('${imageCol1[i].high_res_file.url}')" src="${imageCol1[i].preview_file.url}" class="mb-4 rounded-xl w-full object-cover" style="height: 200px" />`;
            } else
              imageCol1HTML += `<img onclick="showImageFullSize('${imageCol1[i].high_res_file.url}')" src="${imageCol1[i].preview_file.url}" class="mb-4 rounded-xl max-h-100 w-full object-cover" style="min-height:130px" /> `;
          }
          for (let i = 0; i < imageCol2.length; i++) {
            if (i == imageCol2.length - 1) {
              imageCol2HTML += `<img onclick="showImageFullSize('${imageCol2[i].high_res_file.url}')" src="${imageCol2[i].preview_file.url}" class="mb-4 rounded-xl w-full object-cover" style="height: 370px" />`;
            } else
              imageCol2HTML += `<img onclick="showImageFullSize('${imageCol2[i].high_res_file.url}')" src="${imageCol2[i].preview_file.url}" class="mb-4 rounded-xl max-h-100 w-full object-cover" style="min-height:130px" /> `;
          }

          document.getElementById("galeryCol1").innerHTML = imageCol1HTML;
          document.getElementById("galeryCol2").innerHTML = imageCol2HTML;
          document.getElementById("bigImagesGalery").innerHTML = "";
        } else {
          let bigImagesHTML = "";
          document.getElementById("galeryCol1").innerHTML = "";
          document.getElementById("galeryCol2").innerHTML = "";
          for (let i = 0; i < iamgeGalery.length; i++) {
            bigImagesHTML += `<img onclick="showImageFullSize('${iamgeGalery[i].high_res_file.url}')" src="${iamgeGalery[i].low_res_file.url}" class="mb-2 rounded-lg w-full object-cover" style="max-height: 1000px" />`;
          }
          document.getElementById("bigImagesGalery").innerHTML = bigImagesHTML;
        }

        //scrollToTop();
      }

      async function getGaleyImages() {
        tagsSelected = await JSON.parse(
          window.localStorage.getItem("tagsSelected")
        );
        $("#tagsSearched").addClass("hidden");

        printRelatedSelected();
        let tagsUser = await JSON.parse(
          window.localStorage.getItem("tagsSelected")
        ).join("%7C");

        let currentPage = window.localStorage.getItem("currentPage");
        if (currentPage == null) {
          pageID = 0;
        } else {
          pageID = Number(currentPage);
        }

        let reqOptions = {
          url: `${BACKEND_URL}/rule/galery/${tagsUser}/${pageID}`,
          method: "GET",
        };

        let response = await axios.request(reqOptions);

        if (!response.data.null) {
          iamgeGalery = response.data;
          printimages();
          showSelectedTagsOnInit();
        } else {
          console.log("no se ha encontrado nada");
        }
      }

      getGaleyImages();

      async function useSearchInWeb() {
        await window.localStorage.setItem(
          "tagsSelected",
          JSON.stringify(tagsSelected)
        );
        iamgeGalery = [];
        /* $("#searchContainer").addClass("hidden"); */

        getGaleyImages();
      }

      function openSearchInweb() {
        $("#searchContainer").removeClass("hidden");
      }

      function nextPage() {
        iamgeGalery = [];
        imageCol1 = [];
        imageCol2 = [];
        imageCol1HTML = "";
        imageCol2HTML = "";
        pageID++;

        getGaleyImages();
        window.localStorage.setItem("currentPage", pageID);
      }

      function previousPage() {
        iamgeGalery = [];
        imageCol1 = [];
        imageCol2 = [];
        imageCol1HTML = "";
        imageCol2HTML = "";

        if (pageID !== 0) {
          pageID--;

          getGaleyImages();
          scrollToTop(document.getElementById("galeryContainer"));
          window.localStorage.setItem("currentPage", pageID);
        }
      }

      async function changeImagesSize() {
        let smallImages = await window.localStorage.getItem("smallImages");
        if (smallImages == "true") {
          window.localStorage.setItem("smallImages", "false");
        } else {
          window.localStorage.setItem("smallImages", "true");
        }

        printimages();
      }

      async function showImageFullSize(imageLink) {
        window.localStorage.setItem("fullImage", imageLink);
        $("#appShowImageFull").html(`
				<div
				id="imageContainer"
				class="w-screen h-screen flex justify-center items-center fixed top-0 left-0 z-10 bg-black"
				></div>
				<div
					class="fixed flex justify-center items-center top-0 left-0 bg-white z-20 m-5 w-15 h-15 rounded-full"
				>
				<i
					onclick="closeImageFullSize()"
					stroke-width="1"
					data-feather="arrow-left"
					style="width: 35px; height: 35px; opacity: 0.4"
					class="m-2"
				></i>
				</div>
				`);
        $("#appShowImageFull").removeClass("hidden");
        getImageLink();
        feather.replace();
      }

      function closeImageFullSize() {
        $("#appShowImageFull").addClass("hidden");
        $("#appShowImageFull").html("");
      }

      function getImageLink() {
        let imageLink = window.localStorage.getItem("fullImage");
        let typeFile = imageLink.split(".").pop();
        console.log(typeFile);
        let HTMLImageLink;
        if (typeFile == "mp4") {
          HTMLImageLink = `<video
									data-src="${imageLink}"
									poster="${imageLink}"
									controls="controls"
									loop="loop"
									playsinline=""
									preload="none"
									class="h-screen w-screen"
									autoplay
									muted
									style="aspect-ratio: 1920 / 1080"
									src="${imageLink}"
									></video>`;
        } else {
          HTMLImageLink =
            "<img class='w-full h-full object-contain relative z-10' src='" +
            imageLink +
            "' /> <img class='blur absolute w-full h-full object-cover z-0' src='" +
            imageLink +
            "' />";
        }

        document.getElementById("imageContainer").innerHTML = HTMLImageLink;
        console.log(imageLink);
      }
    </script>
  </body>
</html>
