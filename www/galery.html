<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>RuleApp - Galery</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script src="https://unpkg.com/feather-icons"></script>
		<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	</head>
	<body id="app">
		<div id="scrollContent" class="-mt-5 mb-12"></div>
		<div
			id="searchContainer"
			class="hidden bg-white p-5 z-5 w-screen h-screen fixed top-0 left-0 flex flex-col justify-center items-center"
		>
			<div class="flex flex-col w-screen px-6">
				<div
					id="tagsSelectedSearch"
					class="flex list-none flex-row overflow-x-scroll overflow-hidden"
				></div>
			</div>
			<div class="flex px-6 flex-row w-screen h-20 p-3 mt-2">
				<div
					class="flex flex-row items-center w-full mb-2 p-3 rounded-full border-2 border-2 border-black"
				>
					<i
						stroke-width="1"
						data-feather="search"
						style="width: 22px; height: 22px; opacity: 0.4"
						class="mx-2"
					></i>
					<input
						class="w-full h-full outline-transparent"
						placeholder="Search tags..."
						type="text"
						id="searchTagsInput"
					/>
				</div>
			</div>
			<div
				id="tagsSearched"
				class="flex w-full px-2 pl-0 pt-0 min-h-10 rounded-full overflow-x-scroll mb-3"
			></div>
			<div class="flex flex-row items-center w-full">
				<button
					onclick="closeSearchInWeb()"
					class="bg-gray-100 text-white mr-1 w-20 h-12 rounded-full flex items-center justify-center"
				>
					<i
						stroke-width="2"
						data-feather="arrow-left"
						style="width: 20px; height: 20px; opacity: 1"
						class="mx-2 text-white"
						stroke="black"
					></i>
				</button>
				<button
					onclick="useSearchInWeb()"
					class="bg-black text-white ml-1 flex-auto w-full min-w-200 h-12 rounded-full flex items-center justify-center"
				>
					<span class="text-white">Search</span>
					<i
						stroke-width="2"
						data-feather="search"
						style="width: 20px; height: 20px; opacity: 1"
						class="mx-2 text-white"
						stroke="white"
					></i>
				</button>
			</div>
		</div>
		<div id="galeryContainer">
			<!--  -->

			<div
				style="height: 65px; margin-top: -80px"
				class="justify-center flex-row items-center shadow-xl rounded-full top-full flex w-[calc(100%-2.5rem)] fixed bg-white mx-5"
			>
				<a href="./index.html">
					<i
						stroke-width="1"
						data-feather="arrow-left"
						style="width: 30px; height: 30px; opacity: 0.4"
						class="mx-4"
					></i>
				</a>
				<i
					stroke-width="1"
					data-feather="home"
					style="width: 30px; height: 30px; opacity: 1"
					class="mx-4"
				></i>
				<i
					onclick="openSearchInweb()"
					stroke-width="1"
					data-feather="search"
					style="width: 30px; height: 30px; opacity: 0.4"
					class="mx-4"
				></i>

				<i
					onclick="changeImagesSize()"
					stroke-width="1"
					data-feather="image"
					style="width: 30px; height: 30px; opacity: 0.4"
					class="mx-4"
				></i>
				<i
					stroke-width="1"
					data-feather="columns"
					style="width: 30px; height: 30px; opacity: 0.4"
					class="mx-4"
				></i>
			</div>
			<div
				id="tagsSelected"
				class="flex list-none mt-5 flex-row p-5 pt-0 pl-2 pb-0 overflow-x-scroll overflow-hidden"
			></div>
			<div class="flex flex-row p-1 width-full flex-wrap pt-5">
				<div class="w-[calc(50%-8px)] mx-1" id="galeryCol1"></div>
				<div class="w-[calc(50%-8px)] mx-1" id="galeryCol2"></div>
			</div>
			<div
				id="bigImagesGalery"
				class="flex flex-row p-1 width-full flex-wrap pt-5 -mt-5"
			></div>
			<div
				class="flex flex-row p-1 w-full mt-10 justify-center"
				style="margin-bottom: 150px"
			>
				<div class="h-10 flex items-center justify-center">
					<i
						onclick="previousPage()"
						stroke-width="1"
						data-feather="chevron-left"
						style="width: 30px; height: 30px; opacity: 1"
						class="mx-4"
					></i>
				</div>
				<div
					class="flex flex-row items-center w-100 justify-center items-center"
				>
					<div
						id="pageNumber"
						class="mx-1 bg-black rounded-full text-white flex h-10 items-center px-4 justify-center"
					>
						<span>Page 1</span>
					</div>
				</div>
				<div class="h-10 flex items-center justify-center">
					<i
						onclick="nextPage()"
						stroke-width="1"
						data-feather="chevron-right"
						style="width: 30px; height: 30px; opacity: 1"
						class="mx-4"
					></i>
				</div>
			</div>
		</div>
		<script
			type="text/javascript"
			src="https://code.jquery.com/jquery-1.12.3.js"
		></script>
		<script>
			const BACKEND_URL = "https://ruleappserver-10d4170b9aef.herokuapp.com";

			let pageID = 0;

			feather.replace();

			let iamgeGalery = [];

			let tagsSelected = [
				{ id: 1, name: "one_piece" },
				{ id: 2, name: "animated" },
				{ id: 2, name: "luffy" },
				{ id: 2, name: "luffy_nami" },
				{ id: 2, name: "animated" },
			];

			let imageCol1 = [];
			let imageCol2 = [];
			let imageCol1HTML = "";
			let imageCol2HTML = "";

			$("#searchTagsInput").on("input", function () {
				searchTagsInput($(this).val());
			});

			//hacer scroll hasta el final de las tags
			function scrollToHorizontalEnd(element) {
				element.scrollLeft = element.scrollWidth - element.clientWidth;
			}
			//==========================================================================

			async function deleteTagsSelected(index) {
				tagsSelected.splice(index, 1);
				document.getElementById("tagsSelectedSearch").innerHTML =
					tagsSelected.map((tag, index) => {
						return `<li onclick="deleteTagsSelected(${index})" style="white-space: nowrap"  class="h-9 hover:opacity-40 mx-1 items-center justify-center flex font-bold list-none bg-black text-white p-1 px-4 rounded-full"><span class="ml-2">${tag}</span><img class="w-5 h-5 ml-1" src="./img/x(1).svg"/></li>`;
					});
				await window.localStorage.setItem(
					"tagsSelected",
					JSON.stringify(tagsSelected)
				);
				getGaleyImages();
			}
			async function showSelectedTagsOnInit() {
				tagsSelected = [];
				tagsSelected = await JSON.parse(
					window.localStorage.getItem("tagsSelected")
				);
				document.getElementById("tagsSelectedSearch").innerHTML =
					tagsSelected.map((tag, index) => {
						return `<li onclick="deleteTagsSelected(${index})" style="white-space: nowrap"  class="h-9 hover:opacity-40 mr-2 items-center justify-center flex font-bold list-none bg-black text-white p-1 px-4 rounded-full"><span class="ml-2">${tag}</span><img class="w-5 h-5 ml-1" src="./img/x(1).svg"/></li>`;
					});

				const scrollableElement = document.getElementById("tagsSelectedSearch");
				scrollToHorizontalEnd(scrollableElement);
				document.getElementById("searchTagsInput").value = "";
			}
			function addTags(tags) {
				tagsSelected.push(tags);
				document.getElementById("tagsSelectedSearch").innerHTML =
					tagsSelected.map((tag, index) => {
						return `<li onclick="deleteTagsSelected(${index})" style="white-space: nowrap"  class="h-9 hover:opacity-40 mr-2 items-center justify-center flex font-bold list-none bg-black text-white p-1 px-4 rounded-full"><span class="ml-2">${tag}</span><img class="w-5 h-5 ml-1" src="./img/x(1).svg"/></li>`;
					});

				const scrollableElement = document.getElementById("tagsSelectedSearch");
				scrollToHorizontalEnd(scrollableElement);
				document.getElementById("searchTagsInput").value = "";
			}

			function showSelectedTags(tags) {
				$("#tagsSearched").removeClass("hidden");
				document.getElementById("tagsSearched").innerHTML = tags.map((tag) => {
					return `<li onclick="addTags('${tag.name}')" style="white-space: nowrap" class="hover:opacity-40 flex items-center w-auto mx-1 max-h-9 list-none bg-white border-2 border-black text-black p-1 px-5 rounded-full" > ${tag.name} <img class="w-3 h-3 ml-2" src="./img/arrow1.png"/> </li>`;
				});
			}

			async function searchTagsInput(el) {
				const textoConGuiones = el.replaceAll(/ /g, "_");
				$("#searchTagsInput").val(textoConGuiones);

				let reqOptions = {
					url: `${BACKEND_URL}/rule/tags/${el}`,
					method: "GET",
				};

				let response = await axios.request(reqOptions);
				if (!response.data.null) {
					showSelectedTags(response.data);
				} else {
					console.log("no se ha encontrado nada");
				}
			}

			function scrollToTop(element) {
				window.scrollTo({
					top: 0,
					behavior: "smooth",
				});
				//element.scrollIntoView({ behavior: "smooth", block: "start" });
			}

			async function printRelatedSelected() {
				let tagsHTML = "";
				console.log(tagsSelected);
				let reqOptions = {
					url: `${BACKEND_URL}/rule/tags/${tagsSelected[0]}`,
					method: "GET",
				};

				let response = await axios.request(reqOptions);
				if (!response.data.null) {
					response.data.forEach((tag, index) => {
						tagsHTML += `<li onclick="deleteTagsSelected(${index})" style="white-space: nowrap"  class="h-9 hover:opacity-40 mx-1 items-center justify-center flex font-bold list-none bg-gray-100 text-gray-400 p-1 px-4 rounded-full"><span class="ml-2">${tag.name}</span></li>`;
					});
					document.getElementById("tagsSelected").innerHTML = tagsHTML;
				} else {
					console.log("no se ha encontrado nada");
				}
			}
			async function printimages() {
				let smallImagesLocalStorage = await window.localStorage.getItem(
					"smallImages"
				);
				$("#galeryCol1").html("");
				$("#galeryCol2").html("");
				$("#bigImagesGalery").html("");
				imageCol1 = [];
				imageCol2 = [];
				imageCol1HTML = "";
				imageCol2HTML = "";

				document.getElementById("pageNumber").innerHTML = `<span>Page ${
					pageID + 1
				}</span>`;

				if (smallImagesLocalStorage == "true") {
					for (let i = 0; i < iamgeGalery.length; i++) {
						if (i % 2 == 0) {
							imageCol1.push(iamgeGalery[i]);
						} else {
							imageCol2.push(iamgeGalery[i]);
						}
					}

					for (let i = 0; i < imageCol1.length; i++) {
						if (i == imageCol1.length - 1) {
							imageCol1HTML += `<img onclick="showImageFullSize('${imageCol1[i].high_res_file.url}')" src="${imageCol1[i].preview_file.url}" class="mb-2 rounded-lg w-full object-cover" style="height: 200px" />`;
						} else
							imageCol1HTML += `<img onclick="showImageFullSize('${imageCol1[i].high_res_file.url}')" src="${imageCol1[i].preview_file.url}" class="mb-2 rounded-lg max-h-100 w-full object-cover" />`;
					}
					for (let i = 0; i < imageCol2.length; i++) {
						if (i == imageCol2.length - 1) {
							imageCol2HTML += `<img onclick="showImageFullSize('${imageCol2[i].high_res_file.url}')" src="${imageCol2[i].preview_file.url}" class="mb-2 rounded-lg w-full object-cover" style="height: 370px" />`;
						} else
							imageCol2HTML += `<img onclick="showImageFullSize('${imageCol2[i].high_res_file.url}')" src="${imageCol2[i].preview_file.url}" class="mb-2 rounded-lg max-h-100 w-full object-cover" />`;
					}

					document.getElementById("galeryCol1").innerHTML = imageCol1HTML;
					document.getElementById("galeryCol2").innerHTML = imageCol2HTML;
					document.getElementById("bigImagesGalery").innerHTML = "";
				} else {
					let bigImagesHTML = "";
					document.getElementById("galeryCol1").innerHTML = "";
					document.getElementById("galeryCol2").innerHTML = "";
					for (let i = 0; i < iamgeGalery.length; i++) {
						bigImagesHTML += `<img onclick="showImageFullSize('${iamgeGalery[i].high_res_file.url}')" src="${iamgeGalery[i].low_res_file.url}" class="mb-2 rounded-lg w-full object-cover" style="max-height: 1000px" />`;
					}
					document.getElementById("bigImagesGalery").innerHTML = bigImagesHTML;
				}

				scrollToTop();
			}

			async function getGaleyImages() {
				tagsSelected = await JSON.parse(
					window.localStorage.getItem("tagsSelected")
				);
				$("#tagsSearched").addClass("hidden");

				printRelatedSelected();
				let tagsUser = await JSON.parse(
					window.localStorage.getItem("tagsSelected")
				).join("%7C");

				let currentPage = window.localStorage.getItem("currentPage");
				if (currentPage == null) {
					pageID = 0;
				} else {
					pageID = Number(currentPage);
				}

				let reqOptions = {
					url: `${BACKEND_URL}/rule/galery/${tagsUser}/${pageID}`,
					method: "GET",
				};

				let response = await axios.request(reqOptions);

				if (!response.data.null) {
					iamgeGalery = response.data;
					console.log(response.data);
					printimages();
					showSelectedTagsOnInit();
				} else {
					console.log("no se ha encontrado nada");
				}
			}

			getGaleyImages();

			async function useSearchInWeb() {
				await window.localStorage.setItem(
					"tagsSelected",
					JSON.stringify(tagsSelected)
				);
				iamgeGalery = [];
				$("#searchContainer").addClass("hidden");

				getGaleyImages();
			}

			function openSearchInweb() {
				$("#searchContainer").removeClass("hidden");
			}
			function closeSearchInWeb() {
				$("#searchContainer").addClass("hidden");
				$("#tagsSelectedSearch").html("");
				showSelectedTagsOnInit();
			}

			function nextPage() {
				iamgeGalery = [];
				imageCol1 = [];
				imageCol2 = [];
				imageCol1HTML = "";
				imageCol2HTML = "";
				pageID++;

				getGaleyImages();
				window.localStorage.setItem("currentPage", pageID);
			}

			function previousPage() {
				iamgeGalery = [];
				imageCol1 = [];
				imageCol2 = [];
				imageCol1HTML = "";
				imageCol2HTML = "";

				if (pageID !== 0) {
					pageID--;

					getGaleyImages();
					scrollToTop(document.getElementById("galeryContainer"));
					window.localStorage.setItem("currentPage", pageID);
				}
			}

			async function changeImagesSize() {
				let smallImages = await window.localStorage.getItem("smallImages");
				if (smallImages == "true") {
					window.localStorage.setItem("smallImages", "false");
				} else {
					window.localStorage.setItem("smallImages", "true");
				}

				printimages();
			}

			async function showImageFullSize(imageLink) {
				window.localStorage.setItem("fullImage", imageLink);
				window.location.href = "./showFullImage.html";
			}
		</script>
	</body>
</html>
